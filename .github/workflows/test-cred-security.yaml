name: test-cred-security
on:
  pull_request:
    branches:
      - main
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  GO_VERSION: '1.24.6'

  # steps

  # basics/setup
    # setup the macOS environment
    # create two users, A and B (sample names)
    # will run as if we are A
    # setup finch as if it were an application (packaging)
    # confirm only native credstore configured
    # ensure that binaries/sockets were created where expected with proper permissions (host and VM)
    # ensure that the launchagent is loaded
    # configure a local registry with registry docker image, private credentials
    # test the remove script (is launchagent gone)
    # test the install script

  # testing actual functionality
    # pull a large public image without registering
    # test login security
      # add another item (without credhelper), example private creds
      # login to registry, confirm that we can enumerate and only see that
      # call the binary as user B, see what happens
      # essentially, make sure user B cannot do any funny business here
      # make sure root also cannot do anything 
    # tag and push a private image + finch system clear + check the registry got it
    # pull the private image back from the registry
    # credential stress test (might be able to replace the prior test)
      # tag a few large images, different ones
      # push at the same time
      # remove
      # pull at the same time
    # test private buildfiles


    

  # testing if it breaks existing function
    # add ecr-credhelper or something (what happens if both configured)
    # or maybe, just add ecr-credhelper and nothing else
    # login with dummy ECR credentials to some account
    # ensure that it works?

  # cleanup
    # test the uninstall script manually (is launghagent gone)
    # clean up runner environment

  # QUESTIONS -> 
    # what else do we need to test? Build from a private dockerfile? Idk... 
    # are these thorough enough testing
    # do we need to test existing functionality like that?
  

jobs:
  macos-keychain:
    runs-on: ["self-hosted", "macos", "arm64", "14", "test"]
    timeout-minutes: 120
    steps:
      - name: 
        run: |


 

  windows-cred-manager:
    runs-on: ["self-hosted", "windows", "amd64", "test"]
    timeout-minutes: 120
    steps:
      - name: Setup Windows credential tests
        run: |
          # Windows credential manager tests
          echo "Windows credential tests placeholder"

